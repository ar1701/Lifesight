<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= title %></title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link href="/css/modern.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    <div class="app-container">
      <%- include('partials/navbar', { currentPage: 'marketing' }) -%>

      <div class="main-layout">
        <%- include('partials/sidebar') -%>

        <main class="main-content">
          <!-- Page Header -->
          <div class="mb-8">
            <h1 class="mb-2">Marketing Intelligence Dashboard</h1>
            <p class="text-gray-600">
              Comprehensive analysis of marketing performance and business
              outcomes
            </p>
          </div>

          <!-- Action Buttons -->
          <div class="flex gap-4 mb-6">
            <button class="btn btn-primary" id="importDataBtn">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.89 22 5.99 22H18C19.1 22 20 21.1 20 20V8L14 2ZM18 20H6V4H13V9H18V20Z"
                  fill="currentColor"
                />
              </svg>
              Import Sample Data
            </button>
            <button class="btn btn-success" id="uploadCustomDataBtn">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M9 16H15L12 13L9 16ZM12 2C13.1 2 14 2.9 14 4V12H16L12 16L8 12H10V4C10 2.9 10.9 2 12 2ZM19 18V20H5V18H3V20C3 21.1 3.9 22 5 22H19C20.1 22 21 21.1 21 20V18H19Z"
                  fill="currentColor"
                />
              </svg>
              Upload Custom Data
            </button>
            <button class="btn btn-outline" id="refreshDataBtn">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M17.65 6.35C16.2 4.9 14.21 4 12 4C7.58 4 4 7.58 4 12C4 16.42 7.58 20 12 20C15.73 20 18.84 17.45 19.73 14H17.65C16.83 16.33 14.61 18 12 18C8.69 18 6 15.31 6 12C6 8.69 8.69 6 12 6C13.66 6 15.14 6.69 16.22 7.78L13 11H20V4L17.65 6.35Z"
                  fill="currentColor"
                />
              </svg>
              Refresh
            </button>
            <button class="btn btn-outline" id="exportDataBtn">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.89 22 5.99 22H18C19.1 22 20 21.1 20 20V8L14 2ZM18 20H6V4H13V9H18V20ZM8 15.01L9.41 16.42L11 14.84V20H13V14.84L14.59 16.43L16 15.01L12.01 11L8 15.01Z"
                  fill="currentColor"
                />
              </svg>
              Export Report
            </button>
            <button class="btn btn-info" id="dataGuideBtn">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M11 18H13V16H11V18ZM12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM12 20C7.59 20 4 16.41 4 12S7.59 4 12 4 20 7.59 20 12 16.41 20 12 20ZM12 6C9.79 6 8 7.79 8 10H10C10 8.9 10.9 8 12 8S14 8.9 14 10C14 12 11 11.75 11 15H13C13 12.75 16 12.5 16 10C16 7.79 14.21 6 12 6Z"
                  fill="currentColor"
                />
              </svg>
              Data Guide
            </button>
          </div>

          <!-- Loading State -->
          <div id="loadingState" class="loading" style="display: none">
            <div class="spinner"></div>
            <span>Loading marketing data...</span>
          </div>

          <!-- Data Import State -->
          <div id="importState" class="empty-state">
            <div class="empty-state-icon">
              <svg
                width="64"
                height="64"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"
                  fill="currentColor"
                />
              </svg>
            </div>
            <h3>No Marketing Data</h3>
            <p>Import your marketing data to start analyzing performance.</p>
            <button class="btn btn-primary" id="importDataBtnMain">
              <svg
                width="16"
                height="16"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  d="M14 2H6C4.9 2 4 2.9 4 4V20C4 21.1 4.89 22 5.99 22H18C19.1 22 20 21.1 20 20V8L14 2ZM18 20H6V4H13V9H18V20Z"
                  fill="currentColor"
                />
              </svg>
              Import Marketing Data
            </button>
          </div>

          <!-- Dashboard Content -->
          <div id="dashboardContent" style="display: none">
            <!-- Filters Section -->
            <div class="filters-container mb-6">
              <h4 class="mb-4">Filters & Controls</h4>
              <div class="filters-grid">
                <div class="form-group">
                  <label class="form-label">Date Range</label>
                  <div class="flex gap-2">
                    <input type="date" class="form-control" id="startDate" />
                    <input type="date" class="form-control" id="endDate" />
                  </div>
                </div>
                <div class="form-group">
                  <label class="form-label">Platform</label>
                  <select class="form-control" id="platformFilter">
                    <option value="">All Platforms</option>
                    <option value="Facebook">Facebook</option>
                    <option value="Google">Google</option>
                    <option value="TikTok">TikTok</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Tactic</label>
                  <select class="form-control" id="tacticFilter">
                    <option value="">All Tactics</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">State</label>
                  <select class="form-control" id="stateFilter">
                    <option value="">All States</option>
                  </select>
                </div>
              </div>
              <div class="flex gap-3 mt-4">
                <button class="btn btn-primary" id="applyFiltersBtn">
                  Apply Filters
                </button>
                <button class="btn btn-secondary" id="clearFiltersBtn">
                  Clear Filters
                </button>
                <button class="btn btn-outline" id="aiInsightsBtn">
                  <svg
                    width="16"
                    height="16"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M12 2L13.09 8.26L22 9L13.09 9.74L12 16L10.91 9.74L2 9L10.91 8.26L12 2Z"
                      fill="currentColor"
                    />
                  </svg>
                  AI Insights
                </button>
              </div>
            </div>

            <!-- Key Metrics Cards -->
            <div class="metrics-grid mb-8">
              <div class="metric-card">
                <div class="metric-icon primary">
                  <svg
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"
                      fill="currentColor"
                    />
                  </svg>
                </div>
                <div class="metric-value" id="totalROAS">-</div>
                <div class="metric-label">
                  <span
                    class="metric-tooltip"
                    data-tooltip="Return on Ad Spend: Revenue รท Spend. Shows how much revenue you generate for every dollar spent on advertising."
                  >
                    Total ROAS
                  </span>
                </div>
              </div>
              <div class="metric-card">
                <div class="metric-icon success">
                  <svg
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M16 6L18.29 8.29L13.41 13.17L9.41 9.17L2 16.59L3.41 18L9.41 12L13.41 16L19.71 9.71L22 12V6H16Z"
                      fill="currentColor"
                    />
                  </svg>
                </div>
                <div class="metric-value" id="totalROI">-</div>
                <div class="metric-label">
                  <span
                    class="metric-tooltip"
                    data-tooltip="Return on Investment: (Revenue - Spend) รท Spend ร 100. Measures the profitability of your marketing investment."
                  >
                    Total ROI
                  </span>
                </div>
              </div>
              <div class="metric-card">
                <div class="metric-icon warning">
                  <svg
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M12 2L13.09 8.26L22 9L13.09 9.74L12 16L10.91 9.74L2 9L10.91 8.26L12 2Z"
                      fill="currentColor"
                    />
                  </svg>
                </div>
                <div class="metric-value" id="totalCAC">-</div>
                <div class="metric-label">
                  <span
                    class="metric-tooltip"
                    data-tooltip="Customer Acquisition Cost: Total Spend รท New Customers. The cost to acquire one new customer through marketing efforts."
                  >
                    CAC
                  </span>
                </div>
              </div>
              <div class="metric-card">
                <div class="metric-icon info">
                  <svg
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    xmlns="http://www.w3.org/2000/svg"
                  >
                    <path
                      d="M12 2C6.48 2 2 6.48 2 12S6.48 22 12 22 22 17.52 22 12 17.52 2 12 2ZM13 17H11V15H13V17ZM13 13H11V7H13V13Z"
                      fill="currentColor"
                    />
                  </svg>
                </div>
                <div class="metric-value" id="avgCTR">-</div>
                <div class="metric-label">
                  <span
                    class="metric-tooltip"
                    data-tooltip="Click-Through Rate: Clicks รท Impressions ร 100. Percentage of people who clicked your ad after seeing it."
                  >
                    Avg CTR
                  </span>
                </div>
              </div>
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
              <!-- Platform Performance -->
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title">Platform Performance</h5>
                </div>
                <div class="card-body">
                  <canvas id="platformChart" width="400" height="300"></canvas>
                </div>
              </div>

              <!-- ROAS by Platform -->
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title">ROAS by Platform</h5>
                </div>
                <div class="card-body">
                  <canvas id="roasChart" width="400" height="300"></canvas>
                </div>
              </div>
            </div>

            <!-- Time Series and Tactics -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
              <!-- Time Series -->
              <div class="card lg:col-span-2">
                <div class="card-header">
                  <h5 class="card-title">Performance Over Time</h5>
                </div>
                <div class="card-body">
                  <canvas
                    id="timeSeriesChart"
                    width="600"
                    height="300"
                  ></canvas>
                </div>
              </div>

              <!-- Tactic Performance -->
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title">Tactic Performance</h5>
                </div>
                <div class="card-body">
                  <canvas id="tacticChart" width="300" height="300"></canvas>
                </div>
              </div>
            </div>

            <!-- Data Preview and Chat -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
              <!-- Data Preview -->
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title">Data Preview</h5>
                </div>
                <div class="card-body">
                  <div class="table-container">
                    <table class="table" id="dataPreviewTable">
                      <thead>
                        <tr>
                          <th>Date</th>
                          <th>Platform</th>
                          <th>Spend</th>
                          <th>Revenue</th>
                          <th>ROAS</th>
                        </tr>
                      </thead>
                      <tbody id="dataPreviewBody"></tbody>
                    </table>
                  </div>
                  <div class="flex justify-between items-center mt-4">
                    <button class="btn btn-outline btn-sm" id="loadMoreDataBtn">
                      Load More
                    </button>
                    <span class="text-sm text-gray-500" id="dataCount"
                      >Showing 0 records</span
                    >
                  </div>
                </div>
              </div>

              <!-- AI Chat -->
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title">AI Marketing Assistant</h5>
                </div>
                <div class="card-body">
                  <div class="chat-container" style="height: 400px">
                    <div class="chat-messages" id="marketingChatMessages">
                      <div class="message assistant">
                        <div class="message-avatar">AI</div>
                        <div class="message-content">
                          Hi! I'm your marketing AI assistant. Ask me anything
                          about your marketing performance, trends, or
                          optimization strategies.
                        </div>
                      </div>
                    </div>
                    <div class="chat-input">
                      <input
                        type="text"
                        id="marketingChatInput"
                        placeholder="Ask about marketing performance..."
                      />
                      <button class="btn btn-primary" id="marketingSendBtn">
                        <svg
                          width="16"
                          height="16"
                          viewBox="0 0 24 24"
                          fill="none"
                          xmlns="http://www.w3.org/2000/svg"
                        >
                          <path
                            d="M2.01 21L23 12L2.01 3L2 10L17 12L2 14L2.01 21Z"
                            fill="currentColor"
                          />
                        </svg>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Insights Section -->
            <div class="card mb-8">
              <div
                class="card-header d-flex justify-content-between align-items-center"
              >
                <h5 class="card-title">AI-Powered Insights</h5>
                <div class="insight-controls">
                  <div class="btn-group btn-group-sm" role="group">
                    <button
                      type="button"
                      class="btn btn-outline-primary active"
                      id="allInsightsBtn"
                      onclick="showInsightCategory('all')"
                    >
                      All
                    </button>
                    <button
                      type="button"
                      class="btn btn-outline-primary"
                      id="performanceInsightsBtn"
                      onclick="showInsightCategory('performance')"
                    >
                      Performance
                    </button>
                    <button
                      type="button"
                      class="btn btn-outline-primary"
                      id="financialInsightsBtn"
                      onclick="showInsightCategory('financial')"
                    >
                      Financial
                    </button>
                    <button
                      type="button"
                      class="btn btn-outline-primary"
                      id="recommendationInsightsBtn"
                      onclick="showInsightCategory('recommendation')"
                    >
                      Recommendations
                    </button>
                  </div>
                </div>
              </div>
              <div class="card-body">
                <div class="insights-guide mb-4">
                  <div class="alert alert-info">
                    <h6 class="mb-2">๐ Marketing Insights Guide</h6>
                    <p class="mb-2">
                      Our AI analyzes your marketing data to provide actionable
                      insights. Hover over any metric for detailed definitions.
                    </p>
                    <div class="row">
                      <div class="col-md-4">
                        <strong>Performance:</strong> Campaign effectiveness,
                        reach, engagement
                      </div>
                      <div class="col-md-4">
                        <strong>Financial:</strong> ROI, ROAS, costs,
                        profitability
                      </div>
                      <div class="col-md-4">
                        <strong>Recommendations:</strong> Optimization
                        suggestions, next steps
                      </div>
                    </div>
                  </div>
                </div>
                <div id="insightsContainer">
                  <div class="loading">
                    <div class="spinner"></div>
                    <span>Generating insights...</span>
                  </div>
                </div>
                <div
                  class="text-center mt-4"
                  id="generateInsightsSection"
                  style="display: none"
                >
                  <button
                    class="btn btn-primary"
                    onclick="generateSpecificInsights()"
                  >
                    <i class="bi bi-magic"></i>
                    Generate New Insights
                  </button>
                </div>
              </div>
            </div>

            <!-- Detailed Tables -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <!-- Platform Summary -->
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title">Platform Summary</h5>
                </div>
                <div class="card-body">
                  <div class="table-container">
                    <table class="table">
                      <thead>
                        <tr>
                          <th>Platform</th>
                          <th>Spend</th>
                          <th>Revenue</th>
                          <th>ROAS</th>
                          <th>ROI</th>
                        </tr>
                      </thead>
                      <tbody id="platformTableBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>

              <!-- Business Metrics -->
              <div class="card">
                <div class="card-header">
                  <h5 class="card-title">Business Metrics</h5>
                </div>
                <div class="card-body">
                  <div class="table-container">
                    <table class="table">
                      <thead>
                        <tr>
                          <th>Metric</th>
                          <th>Value</th>
                          <th>Unit</th>
                        </tr>
                      </thead>
                      <tbody id="businessTableBody"></tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        let marketingData = null;
        let charts = {};
        let currentFilters = {};

        // Initialize dashboard
        initializeDashboard();

        // Event listeners
        document
          .getElementById("importDataBtn")
          .addEventListener("click", importMarketingData);
        document
          .getElementById("importDataBtnMain")
          .addEventListener("click", importMarketingData);
        document
          .getElementById("refreshDataBtn")
          .addEventListener("click", loadMarketingData);
        document
          .getElementById("exportDataBtn")
          .addEventListener("click", exportData);
        document
          .getElementById("applyFiltersBtn")
          .addEventListener("click", applyFilters);
        document
          .getElementById("clearFiltersBtn")
          .addEventListener("click", clearFilters);
        document
          .getElementById("aiInsightsBtn")
          .addEventListener("click", showAIInsights);
        document
          .getElementById("loadMoreDataBtn")
          .addEventListener("click", loadMoreData);
        document
          .getElementById("marketingSendBtn")
          .addEventListener("click", sendMarketingMessage);
        document
          .getElementById("marketingChatInput")
          .addEventListener("keypress", function (e) {
            if (e.key === "Enter") sendMarketingMessage();
          });

        async function initializeDashboard() {
          await loadMarketingData();
        }

        async function importMarketingData() {
          showLoading();

          try {
            const response = await fetch("/api/marketing/import", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
            });

            const result = await response.json();

            if (response.ok) {
              showSuccess("Marketing data imported successfully!");
              await loadMarketingData();
            } else {
              throw new Error(result.error || "Failed to import data");
            }
          } catch (error) {
            console.error("Error importing data:", error);
            showError(`Error importing data: ${error.message}`);
          }
        }

        async function loadMarketingData() {
          showLoading();

          try {
            const response = await fetch("/api/marketing/analytics");
            const data = await response.json();

            if (response.ok) {
              marketingData = data;
              renderDashboard();
              loadInsights();
              updateFilters();
            } else {
              throw new Error(data.error || "Failed to load data");
            }
          } catch (error) {
            console.error("Error loading data:", error);
            showError(`Error loading data: ${error.message}`);
            showImportState();
          }
        }

        function renderDashboard() {
          if (!marketingData) {
            showImportState();
            return;
          }

          hideLoading();
          document.getElementById("dashboardContent").style.display = "block";
          document.getElementById("importState").style.display = "none";

          // Update key metrics
          updateKeyMetrics();

          // Render charts
          renderPlatformChart();
          renderROASChart();
          renderTimeSeriesChart();
          renderTacticChart();

          // Update tables
          updatePlatformTable();
          updateBusinessTable();
          updateDataPreview();
        }

        function updateKeyMetrics() {
          const summary = marketingData.summary;

          document.getElementById("totalROAS").textContent =
            summary.roas.toFixed(2) + "x";
          document.getElementById("totalROI").textContent =
            summary.roi.toFixed(1) + "%";
          document.getElementById("totalCAC").textContent =
            "$" + summary.cac.toFixed(2);
          document.getElementById("avgCTR").textContent =
            summary.ctr.toFixed(2) + "%";
        }

        function renderPlatformChart() {
          const ctx = document.getElementById("platformChart").getContext("2d");
          const platforms = Object.keys(marketingData.byPlatform);
          const spendData = platforms.map(
            (p) => marketingData.byPlatform[p].spend
          );
          const revenueData = platforms.map(
            (p) => marketingData.byPlatform[p].revenue
          );

          if (charts.platform) charts.platform.destroy();

          charts.platform = new Chart(ctx, {
            type: "bar",
            data: {
              labels: platforms,
              datasets: [
                {
                  label: "Spend",
                  data: spendData,
                  backgroundColor: "rgba(37, 99, 235, 0.8)",
                  borderColor: "rgba(37, 99, 235, 1)",
                  borderWidth: 1,
                },
                {
                  label: "Revenue",
                  data: revenueData,
                  backgroundColor: "rgba(16, 185, 129, 0.8)",
                  borderColor: "rgba(16, 185, 129, 1)",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                },
              },
            },
          });
        }

        function renderROASChart() {
          const ctx = document.getElementById("roasChart").getContext("2d");
          const platforms = Object.keys(marketingData.byPlatform);
          const roasData = platforms.map(
            (p) => marketingData.byPlatform[p].roas
          );

          if (charts.roas) charts.roas.destroy();

          charts.roas = new Chart(ctx, {
            type: "doughnut",
            data: {
              labels: platforms,
              datasets: [
                {
                  data: roasData,
                  backgroundColor: [
                    "rgba(37, 99, 235, 0.8)",
                    "rgba(16, 185, 129, 0.8)",
                    "rgba(245, 158, 11, 0.8)",
                  ],
                  borderColor: [
                    "rgba(37, 99, 235, 1)",
                    "rgba(16, 185, 129, 1)",
                    "rgba(245, 158, 11, 1)",
                  ],
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              plugins: {
                legend: {
                  position: "bottom",
                },
              },
            },
          });
        }

        function renderTimeSeriesChart() {
          const ctx = document
            .getElementById("timeSeriesChart")
            .getContext("2d");
          const timeSeries = marketingData.timeSeries;
          const dates = timeSeries.map((d) => d.date);
          const spendData = timeSeries.map((d) => d.spend);
          const revenueData = timeSeries.map((d) => d.revenue);

          if (charts.timeSeries) charts.timeSeries.destroy();

          charts.timeSeries = new Chart(ctx, {
            type: "line",
            data: {
              labels: dates,
              datasets: [
                {
                  label: "Spend",
                  data: spendData,
                  borderColor: "rgba(239, 68, 68, 1)",
                  backgroundColor: "rgba(239, 68, 68, 0.2)",
                  tension: 0.1,
                },
                {
                  label: "Revenue",
                  data: revenueData,
                  borderColor: "rgba(16, 185, 129, 1)",
                  backgroundColor: "rgba(16, 185, 129, 0.2)",
                  tension: 0.1,
                },
              ],
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                },
              },
            },
          });
        }

        function renderTacticChart() {
          const ctx = document.getElementById("tacticChart").getContext("2d");
          const tactics = Object.keys(marketingData.byTactic);
          const roiData = tactics.map((t) => marketingData.byTactic[t].roi);

          if (charts.tactic) charts.tactic.destroy();

          charts.tactic = new Chart(ctx, {
            type: "bar",
            data: {
              labels: tactics,
              datasets: [
                {
                  label: "ROI (%)",
                  data: roiData,
                  backgroundColor: "rgba(139, 92, 246, 0.8)",
                  borderColor: "rgba(139, 92, 246, 1)",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              indexAxis: "y",
              scales: {
                x: {
                  beginAtZero: true,
                },
              },
            },
          });
        }

        function updatePlatformTable() {
          const tbody = document.getElementById("platformTableBody");
          tbody.innerHTML = "";

          Object.keys(marketingData.byPlatform).forEach((platform) => {
            const data = marketingData.byPlatform[platform];
            const row = tbody.insertRow();
            row.innerHTML = `
            <td>${platform}</td>
            <td>$${data.spend.toFixed(2)}</td>
            <td>$${data.revenue.toFixed(2)}</td>
            <td>${data.roas.toFixed(2)}x</td>
            <td>${data.roi.toFixed(1)}%</td>
          `;
          });
        }

        function updateBusinessTable() {
          const tbody = document.getElementById("businessTableBody");
          const metrics = marketingData.businessMetrics;

          tbody.innerHTML = `
          <tr><td>Total Revenue</td><td>$${metrics.totalRevenue.toFixed(
            2
          )}</td><td>USD</td></tr>
          <tr><td>Total Orders</td><td>${metrics.totalOrders.toLocaleString()}</td><td>Orders</td></tr>
          <tr><td>New Customers</td><td>${metrics.totalCustomers.toLocaleString()}</td><td>Customers</td></tr>
          <tr><td>Revenue per Customer</td><td>$${metrics.revenuePerCustomer.toFixed(
            2
          )}</td><td>USD</td></tr>
          <tr><td>Average Order Value</td><td>$${metrics.orderValue.toFixed(
            2
          )}</td><td>USD</td></tr>
          <tr><td>Profit Margin</td><td>${metrics.profitMargin.toFixed(
            1
          )}%</td><td>%</td></tr>
        `;
        }

        function updateDataPreview() {
          const tbody = document.getElementById("dataPreviewBody");
          const timeSeries = marketingData.timeSeries.slice(0, 10); // Show first 10 records

          tbody.innerHTML = "";
          timeSeries.forEach((record) => {
            const row = tbody.insertRow();
            row.innerHTML = `
            <td>${record.date}</td>
            <td>All Platforms</td>
            <td>$${record.spend.toFixed(2)}</td>
            <td>$${record.revenue.toFixed(2)}</td>
            <td>${record.roas.toFixed(2)}x</td>
          `;
          });

          document.getElementById(
            "dataCount"
          ).textContent = `Showing ${timeSeries.length} of ${marketingData.timeSeries.length} records`;
        }

        function updateFilters() {
          // Update tactic filter
          const tacticFilter = document.getElementById("tacticFilter");
          const tactics = Object.keys(marketingData.byTactic);
          tactics.forEach((tactic) => {
            const option = document.createElement("option");
            option.value = tactic;
            option.textContent = tactic;
            tacticFilter.appendChild(option);
          });

          // Set default date range
          const timeSeries = marketingData.timeSeries;
          if (timeSeries.length > 0) {
            document.getElementById("startDate").value = timeSeries[0].date;
            document.getElementById("endDate").value =
              timeSeries[timeSeries.length - 1].date;
          }
        }

        function applyFilters() {
          currentFilters = {
            startDate: document.getElementById("startDate").value,
            endDate: document.getElementById("endDate").value,
            platform: document.getElementById("platformFilter").value,
            tactic: document.getElementById("tacticFilter").value,
            state: document.getElementById("stateFilter").value,
          };

          // Reload data with filters
          loadMarketingData();
        }

        function clearFilters() {
          document.getElementById("startDate").value = "";
          document.getElementById("endDate").value = "";
          document.getElementById("platformFilter").value = "";
          document.getElementById("tacticFilter").value = "";
          document.getElementById("stateFilter").value = "";

          currentFilters = {};
          loadMarketingData();
        }

        async function loadInsights() {
          try {
            const response = await fetch("/api/marketing/insights");
            const data = await response.json();

            if (response.ok) {
              renderInsights(data.insights);
            }
          } catch (error) {
            console.error("Error loading insights:", error);
          }
        }

        function renderInsights(insights) {
          const container = document.getElementById("insightsContainer");

          if (insights.length === 0) {
            container.innerHTML =
              '<p class="text-gray-500">No insights available at this time.</p>';
            return;
          }

          container.innerHTML = insights
            .map(
              (insight) => `
          <div class="alert alert-${getInsightAlertType(insight.type)}">
            <h6 class="font-semibold mb-2">${insight.title}</h6>
            <p class="mb-2">${insight.message}</p>
            <p class="mb-0"><strong>Recommendation:</strong> ${
              insight.recommendation
            }</p>
          </div>
        `
            )
            .join("");
        }

        function getInsightAlertType(type) {
          switch (type) {
            case "success":
              return "success";
            case "warning":
              return "warning";
            case "performance":
              return "info";
            default:
              return "secondary";
          }
        }

        async function sendMarketingMessage() {
          const input = document.getElementById("marketingChatInput");
          const message = input.value.trim();

          if (!message) return;

          // Add user message
          addMarketingMessage("user", message);
          input.value = "";

          // Show loading
          const loadingId = addMarketingMessage(
            "assistant",
            "Analyzing your marketing data...",
            true
          );

          try {
            const response = await fetch("/api/marketing/insights");
            const data = await response.json();

            // Remove loading message
            document.getElementById(loadingId).remove();

            if (response.ok) {
              // Generate AI response based on message
              const aiResponse = generateAIResponse(message, data.analytics);
              addMarketingMessage("assistant", aiResponse);
            } else {
              addMarketingMessage(
                "assistant",
                "Sorry, I encountered an error while analyzing your data."
              );
            }
          } catch (error) {
            document.getElementById(loadingId).remove();
            addMarketingMessage(
              "assistant",
              "Sorry, I encountered an error while analyzing your data."
            );
          }
        }

        function generateAIResponse(message, analytics) {
          const lowerMessage = message.toLowerCase();

          if (
            lowerMessage.includes("roas") ||
            lowerMessage.includes("return on ad spend")
          ) {
            const bestPlatform = Object.keys(analytics.byPlatform).reduce(
              (best, platform) => {
                return analytics.byPlatform[platform].roas >
                  analytics.byPlatform[best]?.roas
                  ? platform
                  : best;
              },
              Object.keys(analytics.byPlatform)[0]
            );

            return `Your best performing platform for ROAS is ${bestPlatform} with ${analytics.byPlatform[
              bestPlatform
            ].roas.toFixed(
              2
            )}x return. Consider increasing budget allocation to this platform for better returns.`;
          }

          if (
            lowerMessage.includes("roi") ||
            lowerMessage.includes("return on investment")
          ) {
            const overallROI = analytics.summary.roi;
            if (overallROI > 100) {
              return `Your overall ROI is ${overallROI.toFixed(
                1
              )}%, which is excellent! This indicates very profitable marketing spend. Continue your current strategy while monitoring for optimization opportunities.`;
            } else {
              return `Your overall ROI is ${overallROI.toFixed(
                1
              )}%. Consider reviewing underperforming campaigns and reallocating budget to higher-performing channels.`;
            }
          }

          if (
            lowerMessage.includes("ctr") ||
            lowerMessage.includes("click through rate")
          ) {
            const avgCTR = analytics.summary.ctr;
            if (avgCTR < 1) {
              return `Your average CTR is ${avgCTR.toFixed(
                2
              )}%, which is below industry standards. I recommend reviewing your ad creative and targeting to improve engagement.`;
            } else {
              return `Your average CTR is ${avgCTR.toFixed(
                2
              )}%, which is performing well. Keep monitoring and testing new creative variations.`;
            }
          }

          return `Based on your marketing data, I can see ${analytics.summary.totalSpend.toLocaleString()} in total spend generating ${analytics.summary.totalRevenue.toLocaleString()} in revenue. Your overall ROAS is ${analytics.summary.roas.toFixed(2)}x. Would you like me to dive deeper into any specific metric or platform?`;
        }

        function addMarketingMessage(sender, content, isLoading = false) {
          const messagesContainer = document.getElementById(
            "marketingChatMessages"
          );
          const messageId = "msg-" + Date.now();

          const messageDiv = document.createElement("div");
          messageDiv.className = `message ${sender}`;
          messageDiv.id = messageId;

          const avatar = document.createElement("div");
          avatar.className = "message-avatar";
          avatar.textContent = sender === "user" ? "U" : "AI";

          const messageContent = document.createElement("div");
          messageContent.className = "message-content";
          messageContent.innerHTML = content;

          messageDiv.appendChild(avatar);
          messageDiv.appendChild(messageContent);
          messagesContainer.appendChild(messageDiv);

          messagesContainer.scrollTop = messagesContainer.scrollHeight;

          return messageId;
        }

        function loadMoreData() {
          // Implement pagination for data preview
          updateDataPreview();
        }

        async function exportData() {
          try {
            showLoading();

            const response = await fetch("/api/marketing/export");

            if (response.ok) {
              const blob = await response.blob();
              const url = window.URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.style.display = "none";
              a.href = url;
              a.download = "marketing_data_export.csv";
              document.body.appendChild(a);
              a.click();
              window.URL.revokeObjectURL(url);
              document.body.removeChild(a);

              showSuccess("Data exported successfully!");
            } else {
              throw new Error("Failed to export data");
            }
          } catch (error) {
            console.error("Export error:", error);
            showError("Failed to export data. Please try again.");
          } finally {
            hideLoading();
          }
        }

        function showAIInsights() {
          // Scroll to insights section
          document
            .getElementById("insightsContainer")
            .scrollIntoView({ behavior: "smooth" });
        }

        function showLoading() {
          document.getElementById("loadingState").style.display = "flex";
          document.getElementById("dashboardContent").style.display = "none";
          document.getElementById("importState").style.display = "none";
        }

        function showImportState() {
          document.getElementById("loadingState").style.display = "none";
          document.getElementById("dashboardContent").style.display = "none";
          document.getElementById("importState").style.display = "block";
        }

        function hideLoading() {
          document.getElementById("loadingState").style.display = "none";
        }

        function showSuccess(message) {
          console.log("Success:", message);
        }

        function showError(message) {
          console.error("Error:", message);
        }

        // Selective insights functionality
        let allInsights = [];
        let currentInsightCategory = "all";

        function showInsightCategory(category) {
          currentInsightCategory = category;

          // Update button states
          document.querySelectorAll(".insight-controls .btn").forEach((btn) => {
            btn.classList.remove("active");
          });
          document
            .getElementById(category + "InsightsBtn")
            .classList.add("active");

          // Filter and display insights
          filterInsights(category);
        }

        function filterInsights(category) {
          const container = document.getElementById("insightsContainer");

          if (!allInsights || allInsights.length === 0) {
            container.innerHTML =
              '<p class="text-gray-500">No insights available. Generate insights first.</p>';
            document.getElementById("generateInsightsSection").style.display =
              "block";
            return;
          }

          let filteredInsights = allInsights;

          if (category !== "all") {
            filteredInsights = allInsights.filter((insight) => {
              switch (category) {
                case "performance":
                  return (
                    insight.type === "performance" ||
                    insight.title.toLowerCase().includes("performance") ||
                    insight.title.toLowerCase().includes("ctr") ||
                    insight.title.toLowerCase().includes("click")
                  );
                case "financial":
                  return (
                    insight.type === "financial" ||
                    insight.title.toLowerCase().includes("roi") ||
                    insight.title.toLowerCase().includes("roas") ||
                    insight.title.toLowerCase().includes("cost") ||
                    insight.title.toLowerCase().includes("revenue")
                  );
                case "recommendation":
                  return (
                    insight.type === "recommendation" ||
                    insight.message.toLowerCase().includes("recommend") ||
                    insight.message.toLowerCase().includes("should") ||
                    insight.message.toLowerCase().includes("optimize")
                  );
                default:
                  return true;
              }
            });
          }

          if (filteredInsights.length === 0) {
            container.innerHTML = `<p class="text-gray-500">No ${category} insights available.</p>`;
            return;
          }

          container.innerHTML = filteredInsights
            .map(
              (insight) => `
              <div class="alert alert-${getInsightAlertType(
                insight.type
              )} mb-3">
                <h6 class="font-semibold mb-2">${insight.title}</h6>
                <p class="mb-2">${insight.message}</p>
                <p class="mb-0"><strong>Recommendation:</strong> ${
                  insight.recommendation
                }</p>
              </div>
            `
            )
            .join("");
        }

        function generateSpecificInsights() {
          loadInsights();
        }

        // Override the existing renderInsights function to store insights
        const originalRenderInsights = renderInsights;
        renderInsights = function (insights) {
          allInsights = insights;
          document.getElementById("generateInsightsSection").style.display =
            "block";
          filterInsights(currentInsightCategory);
        };

        // Custom data upload functionality
        function showCustomDataUpload() {
          new bootstrap.Modal(
            document.getElementById("customDataUploadModal")
          ).show();
        }

        function showDataGuide() {
          new bootstrap.Modal(document.getElementById("dataGuideModal")).show();
        }

        async function uploadCustomData() {
          const campaignFiles =
            document.getElementById("campaignDataFile").files;
          const businessFile =
            document.getElementById("businessDataFile").files[0];

          if (campaignFiles.length === 0 && !businessFile) {
            showError("Please select at least one file to upload.");
            return;
          }

          const formData = new FormData();

          // Add campaign files
          for (let i = 0; i < campaignFiles.length; i++) {
            formData.append("campaignFiles", campaignFiles[i]);
          }

          // Add business file
          if (businessFile) {
            formData.append("businessFile", businessFile);
          }

          try {
            showLoading();

            const response = await fetch("/api/marketing/upload-custom", {
              method: "POST",
              body: formData,
            });

            const result = await response.json();

            if (response.ok) {
              bootstrap.Modal.getInstance(
                document.getElementById("customDataUploadModal")
              ).hide();
              showSuccess("Custom data uploaded successfully!");
              await loadMarketingData();

              // Clear file inputs
              document.getElementById("campaignDataFile").value = "";
              document.getElementById("businessDataFile").value = "";
            } else {
              throw new Error(result.error || "Failed to upload data");
            }
          } catch (error) {
            console.error("Error uploading data:", error);
            showError(`Error uploading data: ${error.message}`);
          } finally {
            hideLoading();
          }
        }

        function downloadTemplate(type) {
          let csvContent, filename;

          if (type === "campaign") {
            csvContent = `campaign_name,platform,date,spend,impressions,clicks,attributed_revenue
Summer Sale,Facebook,2024-01-01,1000,50000,2500,5000
Holiday Campaign,Google,2024-01-02,1500,75000,3000,7500
Brand Awareness,TikTok,2024-01-03,800,40000,1600,3200`;
            filename = "campaign_data_template.csv";
          } else {
            csvContent = `date,total_revenue,total_orders,new_customers,cogs
2024-01-01,15000,150,45,9000
2024-01-02,18000,180,52,10800
2024-01-03,12000,120,38,7200`;
            filename = "business_data_template.csv";
          }

          const blob = new Blob([csvContent], { type: "text/csv" });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.style.display = "none";
          a.href = url;
          a.download = filename;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        }

        // Add event listeners for new buttons
        document.addEventListener("DOMContentLoaded", function () {
          document
            .getElementById("uploadCustomDataBtn")
            .addEventListener("click", showCustomDataUpload);
          document
            .getElementById("dataGuideBtn")
            .addEventListener("click", showDataGuide);
        });
      });
    </script>

    <!-- Custom Data Upload Modal -->
    <div class="modal fade" id="customDataUploadModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Upload Custom Marketing Data</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-info">
              <h6 class="mb-2">๐ Supported File Formats</h6>
              <p class="mb-0">
                Upload CSV or Excel files (.csv, .xlsx, .xls) with your
                marketing and business data.
              </p>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <h6 class="mb-0">Marketing Campaign Data</h6>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <label class="form-label">Upload Campaign Data</label>
                      <input
                        type="file"
                        class="form-control"
                        id="campaignDataFile"
                        accept=".csv,.xlsx,.xls"
                        multiple
                      />
                      <small class="form-text text-muted"
                        >Facebook, Google, TikTok campaign data</small
                      >
                    </div>
                    <div class="required-columns">
                      <strong>Required Columns:</strong>
                      <ul class="small mt-1">
                        <li>campaign_name</li>
                        <li>platform (Facebook/Google/TikTok)</li>
                        <li>date</li>
                        <li>spend</li>
                        <li>impressions</li>
                        <li>clicks</li>
                        <li>attributed_revenue</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card">
                  <div class="card-header">
                    <h6 class="mb-0">Business Metrics Data</h6>
                  </div>
                  <div class="card-body">
                    <div class="mb-3">
                      <label class="form-label">Upload Business Data</label>
                      <input
                        type="file"
                        class="form-control"
                        id="businessDataFile"
                        accept=".csv,.xlsx,.xls"
                      />
                      <small class="form-text text-muted"
                        >Revenue, orders, customer data</small
                      >
                    </div>
                    <div class="required-columns">
                      <strong>Required Columns:</strong>
                      <ul class="small mt-1">
                        <li>date</li>
                        <li>total_revenue</li>
                        <li>total_orders</li>
                        <li>new_customers</li>
                        <li>cogs (Cost of Goods Sold)</li>
                      </ul>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="mt-4">
              <div class="alert alert-warning">
                <h6 class="mb-2">๐ Data Format Guidelines</h6>
                <ul class="mb-0">
                  <li>
                    <strong>Date Format:</strong> YYYY-MM-DD (e.g., 2024-01-15)
                  </li>
                  <li>
                    <strong>Numbers:</strong> No currency symbols, use decimal
                    points
                  </li>
                  <li>
                    <strong>Platform Names:</strong> Exactly "Facebook",
                    "Google", or "TikTok"
                  </li>
                  <li>
                    <strong>Headers:</strong> First row must contain column
                    names
                  </li>
                </ul>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="uploadCustomData()"
            >
              <i class="bi bi-upload"></i> Upload Data
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Data Guide Modal -->
    <div class="modal fade" id="dataGuideModal" tabindex="-1">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">๐ Marketing Data Guide & Definitions</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6">
                <div class="card mb-4">
                  <div class="card-header">
                    <h6 class="mb-0">๐ฐ Financial Metrics</h6>
                  </div>
                  <div class="card-body">
                    <div class="metric-definition mb-3">
                      <strong>ROI (Return on Investment)</strong>
                      <p class="mb-1 text-muted">
                        Formula: (Revenue - Spend) รท Spend ร 100
                      </p>
                      <p class="small">
                        Measures the profitability of your marketing investment.
                        Higher is better.
                      </p>
                    </div>
                    <div class="metric-definition mb-3">
                      <strong>ROAS (Return on Ad Spend)</strong>
                      <p class="mb-1 text-muted">Formula: Revenue รท Spend</p>
                      <p class="small">
                        Shows how much revenue you generate for every dollar
                        spent on advertising.
                      </p>
                    </div>
                    <div class="metric-definition mb-3">
                      <strong>COGS (Cost of Goods Sold)</strong>
                      <p class="mb-1 text-muted">
                        Direct costs of producing goods sold
                      </p>
                      <p class="small">
                        Includes materials, labor, and direct overhead costs for
                        products sold.
                      </p>
                    </div>
                    <div class="metric-definition">
                      <strong>CAC (Customer Acquisition Cost)</strong>
                      <p class="mb-1 text-muted">
                        Formula: Total Spend รท New Customers
                      </p>
                      <p class="small">
                        The cost to acquire one new customer through marketing
                        efforts.
                      </p>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="card mb-4">
                  <div class="card-header">
                    <h6 class="mb-0">๐ Performance Metrics</h6>
                  </div>
                  <div class="card-body">
                    <div class="metric-definition mb-3">
                      <strong>CTR (Click-Through Rate)</strong>
                      <p class="mb-1 text-muted">
                        Formula: Clicks รท Impressions ร 100
                      </p>
                      <p class="small">
                        Percentage of people who clicked your ad after seeing
                        it. Higher indicates better ad relevance.
                      </p>
                    </div>
                    <div class="metric-definition mb-3">
                      <strong>CPC (Cost Per Click)</strong>
                      <p class="mb-1 text-muted">
                        Formula: Total Spend รท Total Clicks
                      </p>
                      <p class="small">
                        Average amount you pay for each click on your ads. Lower
                        is generally better.
                      </p>
                    </div>
                    <div class="metric-definition mb-3">
                      <strong>Conversion Rate</strong>
                      <p class="mb-1 text-muted">
                        Formula: Orders รท Clicks ร 100
                      </p>
                      <p class="small">
                        Percentage of clicks that result in a purchase or
                        desired action.
                      </p>
                    </div>
                    <div class="metric-definition">
                      <strong>Impressions</strong>
                      <p class="mb-1 text-muted">
                        Number of times your ad was shown
                      </p>
                      <p class="small">
                        Total reach of your advertising campaigns across all
                        platforms.
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-header">
                <h6 class="mb-0">๐ Sample Data Templates</h6>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <h6>Marketing Campaign Data Template:</h6>
                    <pre
                      class="bg-light p-3 small"
                    ><code>campaign_name,platform,date,spend,impressions,clicks,attributed_revenue
Summer Sale,Facebook,2024-01-01,1000,50000,2500,5000
Holiday Campaign,Google,2024-01-02,1500,75000,3000,7500
Brand Awareness,TikTok,2024-01-03,800,40000,1600,3200</code></pre>
                  </div>
                  <div class="col-md-6">
                    <h6>Business Metrics Data Template:</h6>
                    <pre
                      class="bg-light p-3 small"
                    ><code>date,total_revenue,total_orders,new_customers,cogs
2024-01-01,15000,150,45,9000
2024-01-02,18000,180,52,10800
2024-01-03,12000,120,38,7200</code></pre>
                  </div>
                </div>
                <div class="mt-3">
                  <button
                    class="btn btn-outline-primary btn-sm"
                    onclick="downloadTemplate('campaign')"
                  >
                    <i class="bi bi-download"></i> Download Campaign Template
                  </button>
                  <button
                    class="btn btn-outline-primary btn-sm ms-2"
                    onclick="downloadTemplate('business')"
                  >
                    <i class="bi bi-download"></i> Download Business Template
                  </button>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-primary"
              data-bs-dismiss="modal"
            >
              Got it!
            </button>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
