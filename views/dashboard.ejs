<%- include('partials/header') -%>

<div class="container-fluid">
  <div class="row">
    <!-- Sidebar -->
    <div class="col-md-3 col-lg-2 d-md-block bg-light sidebar">
      <div class="position-sticky pt-3">
        <ul class="nav flex-column">
          <li class="nav-item">
            <a class="nav-link" href="/app">
              <i class="bi bi-house me-2"></i>Home
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/app/dashboards">
              <i class="bi bi-grid-3x3-gap-fill me-2"></i>All Dashboards
            </a>
          </li>
        </ul>
      </div>
    </div>

    <!-- Main content -->
    <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
      <div
        class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom"
      >
        <div>
          <h1 class="h2"><%= dashboard.name %></h1>
          <% if(dashboard.description) { %>
          <p class="text-muted mb-0"><%= dashboard.description %></p>
          <% } %>
        </div>
        <div class="btn-toolbar mb-2 mb-md-0">
          <div class="btn-group me-2">
            <button
              type="button"
              class="btn btn-outline-secondary"
              onclick="history.back()"
            >
              <i class="bi bi-arrow-left me-2"></i>Back
            </button>
          </div>
        </div>
      </div>

      <!-- Dashboard Widgets -->
      <div class="row g-4">
        <% if(widgets && widgets.length > 0) { %> <% widgets.forEach(widget => {
        %>
        <div class="col-md-6 col-lg-4">
          <div
            class="card widget-container h-100"
            data-widget-id="<%= widget._id %>"
          >
            <div
              class="card-header d-flex justify-content-between align-items-center"
            >
              <span class="fw-bold">
                <% if(widget.type === 'chart') { %>
                <i class="bi bi-bar-chart-line me-2"></i>Chart <% } else { %>
                <i class="bi bi-table me-2"></i>Table <% } %>
              </span>
              <button
                type="button"
                class="btn btn-sm btn-outline-danger delete-widget-btn"
                title="Delete Widget"
              >
                <i class="bi bi-trash"></i>
              </button>
            </div>
            <div class="card-body">
              <!-- Widget content will be rendered by JavaScript -->
            </div>
          </div>
        </div>
        <% }) %> <% } else { %>
        <div class="col-12">
          <div class="text-center py-5">
            <i class="bi bi-grid-3x3-gap display-1 text-muted"></i>
            <h3 class="mt-3">No Widgets Yet</h3>
            <p class="text-muted">
              This dashboard is empty. Go to the home page to generate charts
              and tables, then add them to this dashboard.
            </p>
            <a href="/app" class="btn btn-primary">
              <i class="bi bi-plus-circle me-2"></i>Create Widgets
            </a>
          </div>
        </div>
        <% } %>
      </div>
    </main>
  </div>
</div>

<%- include('partials/footer') -%>

<script>
  window.savedWidgets = <%- JSON.stringify(widgets || []) %>;
</script>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // Load and render widgets
    function loadDashboardWidgets() {
      if (window.savedWidgets && window.savedWidgets.length > 0) {
        const widgetsData = window.savedWidgets;
        widgetsData.forEach((widget) => {
          renderWidgetOnDashboard(widget);
        });
      }
    }

    // Render widget on dashboard
    function renderWidgetOnDashboard(widget) {
      const widgetContainer = document.querySelector(
        `[data-widget-id="${widget._id}"]`
      );
      if (!widgetContainer) return;

      const body = widgetContainer.querySelector(".card-body");
      if (!body) return;

      try {
        if (widget.type === "chart") {
          const canvas = document.createElement("canvas");
          canvas.width = 400;
          canvas.height = 300;
          body.appendChild(canvas);

          if (widget.config) {
            new Chart(canvas.getContext("2d"), widget.config);
          }
        } else if (widget.type === "table") {
          const tableHtml = generateTable(widget.data, false);
          body.innerHTML = tableHtml;
        }
      } catch (error) {
        console.error("Error rendering widget:", error);
        body.innerHTML = '<p class="text-muted">Error rendering widget</p>';
      }
    }

    // Generate table HTML
    function generateTable(data, showPagination = true) {
      if (!data || !data.data) {
        return '<p class="text-muted">No data available</p>';
      }

      const headers = data.data.headers || [];
      const rows = data.data.rows || [];

      if (headers.length === 0 || rows.length === 0) {
        return '<p class="text-muted">No data available</p>';
      }

      let tableHtml =
        '<div class="table-responsive"><table class="table table-striped table-hover">';

      // Header
      tableHtml += '<thead class="table-dark"><tr>';
      headers.forEach((header) => {
        tableHtml += `<th>${header}</th>`;
      });
      tableHtml += "</tr></thead>";

      // Body
      tableHtml += "<tbody>";
      rows.forEach((row) => {
        tableHtml += "<tr>";
        row.forEach((cell) => {
          tableHtml += `<td>${cell}</td>`;
        });
        tableHtml += "</tr>";
      });
      tableHtml += "</tbody></table></div>";

      return tableHtml;
    }

    // Delete widget functionality
    document.addEventListener("click", (event) => {
      if (event.target.closest(".delete-widget-btn")) {
        const widgetContainer = event.target.closest(".widget-container");
        const widgetId = widgetContainer.dataset.widgetId;
        deleteWidget(widgetId, widgetContainer);
      }
    });

    async function deleteWidget(widgetId, widgetElement) {
      if (
        !confirm(
          "Are you sure you want to delete this widget? This action cannot be undone."
        )
      ) {
        return;
      }

      try {
        const response = await fetch(`/api/widgets/${widgetId}`, {
          method: "DELETE",
        });
        const result = await response.json();

        if (response.ok) {
          const columnDiv = widgetElement.closest(".col-md-6, .col-lg-4");
          columnDiv.remove();

          // Check if no widgets remain
          const remainingWidgets =
            document.querySelectorAll(".widget-container");
          if (remainingWidgets.length === 0) {
            location.reload(); // Reload to show empty state
          }
        } else {
          throw new Error(result.error || "Failed to delete widget");
        }
      } catch (error) {
        console.error("Error deleting widget:", error);
        alert(`Error deleting widget: ${error.message}`);
      }
    }

    // Initialize
    loadDashboardWidgets();
  });
</script>

<style>
  .sidebar {
    position: fixed;
    top: 56px;
    bottom: 0;
    left: 0;
    z-index: 100;
    padding: 48px 0 0;
    box-shadow: inset -1px 0 0 rgba(0, 0, 0, 0.1);
  }

  .sidebar .nav-link {
    color: #333;
    font-weight: 500;
  }

  .widget-container {
    transition: transform 0.2s ease-in-out;
  }

  .widget-container:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  }
</style>
